### 1、安装模式
  分为三种：单主机模式、普通集群模式、镜像集群模式。
  
  单主机模式：rabbitmq运行在一台主机上，生产环境不建议使用该模式，性能有限。如果该台主机down机，整个服务将不可用。
  
  普通集群模式：对于queue来说，消息实体只存在于一个节点上，集群中其他节点仅有相同的元数据，即队列结构。经过B发送给consumer。所以consumer尽量连接每一个节点，从中去消息，即对于同一个逻辑队列，要在多个节点建立queue。否则consumer如果只连接一个节点区消息会造成该节点的性能瓶颈。
  
  该模式存在当其中一个节点故障后，其他节点无法获取到故障节点中还未消费的消息，如果做了消息持久化，必须等待A节点恢复，然后才可以被消费。
  
  镜像集群模式：该模式会把队列结构和消息都存在于多个节点，属于rabbitmq的HA方案。缺点：降低系统性能。
  
  RabbitMQ的集群节点包括内存节点、磁盘节点。顾名思义内存节点就是将所有数据放在内存，磁盘节点将数据放在磁盘。如果在投递消息时，打开了消息的持久化，那么即使是内存节点，数据还是会放在磁盘。原则上一个集群至少有一个磁盘节点。在实际使用中会发现所谓的磁盘节点是只用来存储集群的配置信息，也就是说如果集群中没有磁盘节点，当所有节点关机后集群的配置信息就会丢失。在进行性能测试时两个模式的节点订阅发布消息的性能没有太大差距。

### 2、多节点流量分发
  RabbitMQ集群模式是没有中心节点的，并且在连接集群的时候实际上Consumer是连接其中某一台节点，连接方法和单主机模式一致。
 
  通过负载均衡设备来实现流量分发。可以使用F5硬件负载均衡，如果没有F5的硬件负载均衡设备也可以使用LVS、haproxy等服务，当Consumer连接集群时实际是先经过负载均衡。首先将集群中所以节点的IP放在一个数组中，app在连接RabbitMQ的时候会从数组中随机选择一个IP来连接，然后把连接的节点的IP缓存到服务器，如果连接超时则重新随机选择其他节点来连接。通过这种方式来实现app流量的分发。
 
### 3、普通集群部署
  ### 1111

haproxy反向代理rabbitmq并开启监控
  ```
  listen stats
   mode http
   bind *:1090
   stats enable
   stats hide-version
   stats uri    /hadmin
   stats auth    admin:admin
   stats admin if TRUE

  listen test_rabbitmq_cluster 0.0.0.0:5672
    mode tcp
    balance roundrobin
    option tcpka
    timeout client 99999m
    timeout server 99999m
    server kvm-dev-mq-redis-192-168-40-102 192.168.40.102:5672 check maxconn 65535 inter 2000 rise 2 fall 3
    server kvm-dev-mq-redis-192-168-40-105 192.168.40.105:5672 check maxconn 65535 inter 2000 rise 2 fall 3
  ```
  
